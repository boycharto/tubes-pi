{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\boy\\\\Desktop\\\\pdf\\\\pdftron-sign-app-master\\\\src\\\\components\\\\PrepareDocument\\\\PrepareDocument.js\",\n    _s = $RefreshSig$();\n\nimport React, { useRef, useEffect, useState } from 'react';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { navigate } from '@reach/router';\nimport { Box, Column, Heading, Row, Stack, Text, Button, SelectList } from 'gestalt';\nimport { selectAssignees, resetSignee } from '../Assign/AssignSlice';\nimport { storage, addDocumentToSign } from '../../firebase/firebase';\nimport { selectUser } from '../../firebase/firebaseSlice';\nimport WebViewer from '@pdftron/webviewer';\nimport 'gestalt/dist/gestalt.css';\nimport './PrepareDocument.css';\n\nconst PrepareDocument = () => {\n  _s();\n\n  const [instance, setInstance] = useState(null);\n  const [dropPoint, setDropPoint] = useState(null);\n  const dispatch = useDispatch();\n  const assignees = useSelector(selectAssignees);\n  const assigneesValues = assignees.map(user => {\n    return {\n      value: user.email,\n      label: user.name\n    };\n  });\n  let initialAssignee = assigneesValues.length > 0 ? assigneesValues[0].value : '';\n  const [assignee, setAssignee] = useState(initialAssignee);\n  const user = useSelector(selectUser);\n  const {\n    uid,\n    email\n  } = user;\n  const viewer = useRef(null);\n  const filePicker = useRef(null); // if using a class, equivalent of componentDidMount\n\n  useEffect(() => {\n    WebViewer({\n      path: 'webviewer',\n      disabledElements: ['ribbons', 'toggleNotesButton', 'searchButton', 'menuButton']\n    }, viewer.current).then(instance => {\n      const {\n        iframeWindow\n      } = instance; // select only the view group\n\n      instance.setToolbarGroup('toolbarGroup-View');\n      setInstance(instance);\n      const iframeDoc = iframeWindow.document.body;\n      iframeDoc.addEventListener('dragover', dragOver);\n      iframeDoc.addEventListener('drop', e => {\n        drop(e, instance);\n      });\n\n      filePicker.current.onchange = e => {\n        const file = e.target.files[0];\n\n        if (file) {\n          instance.loadDocument(file);\n        }\n      };\n    });\n  }, []);\n\n  const applyFields = async () => {\n    const {\n      Annotations,\n      docViewer\n    } = instance;\n    const annotManager = docViewer.getAnnotationManager();\n    const fieldManager = annotManager.getFieldManager();\n    const annotationsList = annotManager.getAnnotationsList();\n    const annotsToDelete = [];\n    const annotsToDraw = [];\n    await Promise.all(annotationsList.map(async (annot, index) => {\n      let inputAnnot;\n      let field;\n\n      if (typeof annot.custom !== 'undefined') {\n        // create a form field based on the type of annotation\n        if (annot.custom.type === 'TEXT') {\n          field = new Annotations.Forms.Field(annot.getContents() + Date.now() + index, {\n            type: 'Tx',\n            value: annot.custom.value\n          });\n          inputAnnot = new Annotations.TextWidgetAnnotation(field);\n        } else if (annot.custom.type === 'SIGNATURE') {\n          field = new Annotations.Forms.Field(annot.getContents() + Date.now() + index, {\n            type: 'Sig'\n          });\n          inputAnnot = new Annotations.SignatureWidgetAnnotation(field, {\n            appearance: '_DEFAULT',\n            appearances: {\n              _DEFAULT: {\n                Normal: {\n                  data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuMWMqnEsAAAANSURBVBhXY/j//z8DAAj8Av6IXwbgAAAAAElFTkSuQmCC',\n                  offset: {\n                    x: 100,\n                    y: 100\n                  }\n                }\n              }\n            }\n          });\n        } else if (annot.custom.type === 'DATE') {\n          field = new Annotations.Forms.Field(annot.getContents() + Date.now() + index, {\n            type: 'Tx',\n            value: 'm-d-yyyy',\n            // Actions need to be added for DatePickerWidgetAnnotation to recognize this field.\n            actions: {\n              F: [{\n                name: 'JavaScript',\n                // You can customize the date format here between the two double-quotation marks\n                // or leave this blank to use the default format\n                javascript: 'AFDate_FormatEx(\"mmm d, yyyy\");'\n              }],\n              K: [{\n                name: 'JavaScript',\n                // You can customize the date format here between the two double-quotation marks\n                // or leave this blank to use the default format\n                javascript: 'AFDate_FormatEx(\"mmm d, yyyy\");'\n              }]\n            }\n          });\n          inputAnnot = new Annotations.DatePickerWidgetAnnotation(field);\n        } else {\n          // exit early for other annotations\n          annotManager.deleteAnnotation(annot, false, true); // prevent duplicates when importing xfdf\n\n          return;\n        }\n      } else {\n        // exit early for other annotations\n        return;\n      } // set position\n\n\n      inputAnnot.PageNumber = annot.getPageNumber();\n      inputAnnot.X = annot.getX();\n      inputAnnot.Y = annot.getY();\n      inputAnnot.rotation = annot.Rotation;\n\n      if (annot.Rotation === 0 || annot.Rotation === 180) {\n        inputAnnot.Width = annot.getWidth();\n        inputAnnot.Height = annot.getHeight();\n      } else {\n        inputAnnot.Width = annot.getHeight();\n        inputAnnot.Height = annot.getWidth();\n      } // delete original annotation\n\n\n      annotsToDelete.push(annot); // customize styles of the form field\n\n      Annotations.WidgetAnnotation.getCustomStyles = function (widget) {\n        if (widget instanceof Annotations.SignatureWidgetAnnotation) {\n          return {\n            border: '1px solid #a5c7ff'\n          };\n        }\n      };\n\n      Annotations.WidgetAnnotation.getCustomStyles(inputAnnot); // draw the annotation the viewer\n\n      annotManager.addAnnotation(inputAnnot);\n      fieldManager.addField(field);\n      annotsToDraw.push(inputAnnot);\n    })); // delete old annotations\n\n    annotManager.deleteAnnotations(annotsToDelete, null, true); // refresh viewer\n\n    await annotManager.drawAnnotationsFromList(annotsToDraw);\n    await uploadForSigning();\n  };\n\n  const addField = (type, point = {}, name = '', value = '', flag = {}) => {\n    const {\n      docViewer,\n      Annotations\n    } = instance;\n    const annotManager = docViewer.getAnnotationManager();\n    const doc = docViewer.getDocument();\n    const displayMode = docViewer.getDisplayModeManager().getDisplayMode();\n    const page = displayMode.getSelectedPages(point, point);\n\n    if (!!point.x && page.first == null) {\n      return; //don't add field to an invalid page location\n    }\n\n    const page_idx = page.first !== null ? page.first : docViewer.getCurrentPage();\n    const page_info = doc.getPageInfo(page_idx);\n    const page_point = displayMode.windowToPage(point, page_idx);\n    const zoom = docViewer.getZoom();\n    var textAnnot = new Annotations.FreeTextAnnotation();\n    textAnnot.PageNumber = page_idx;\n    const rotation = docViewer.getCompleteRotation(page_idx) * 90;\n    textAnnot.Rotation = rotation;\n\n    if (rotation === 270 || rotation === 90) {\n      textAnnot.Width = 50.0 / zoom;\n      textAnnot.Height = 250.0 / zoom;\n    } else {\n      textAnnot.Width = 250.0 / zoom;\n      textAnnot.Height = 50.0 / zoom;\n    }\n\n    textAnnot.X = (page_point.x || page_info.width / 2) - textAnnot.Width / 2;\n    textAnnot.Y = (page_point.y || page_info.height / 2) - textAnnot.Height / 2;\n    textAnnot.setPadding(new Annotations.Rect(0, 0, 0, 0));\n    textAnnot.custom = {\n      type,\n      value,\n      flag,\n      name: `${assignee}_${type}_`\n    }; // set the type of annot\n\n    textAnnot.setContents(textAnnot.custom.name);\n    textAnnot.FontSize = '' + 20.0 / zoom + 'px';\n    textAnnot.FillColor = new Annotations.Color(211, 211, 211, 0.5);\n    textAnnot.TextColor = new Annotations.Color(0, 165, 228);\n    textAnnot.StrokeThickness = 1;\n    textAnnot.StrokeColor = new Annotations.Color(0, 165, 228);\n    textAnnot.TextAlign = 'center';\n    textAnnot.Author = annotManager.getCurrentUser();\n    annotManager.deselectAllAnnotations();\n    annotManager.addAnnotation(textAnnot, true);\n    annotManager.redrawAnnotation(textAnnot);\n    annotManager.selectAnnotation(textAnnot);\n  };\n\n  const uploadForSigning = async () => {\n    // upload the PDF with fields as AcroForm\n    const storageRef = storage.ref();\n    const referenceString = `docToSign/${uid}${Date.now()}.pdf`;\n    const docRef = storageRef.child(referenceString);\n    const {\n      docViewer,\n      annotManager\n    } = instance;\n    const doc = docViewer.getDocument();\n    const xfdfString = await annotManager.exportAnnotations({\n      widgets: true,\n      fields: true\n    });\n    const data = await doc.getFileData({\n      xfdfString\n    });\n    const arr = new Uint8Array(data);\n    const blob = new Blob([arr], {\n      type: 'application/pdf'\n    });\n    docRef.put(blob).then(function (snapshot) {\n      console.log('Uploaded the blob');\n    }); // create an entry in the database\n\n    const emails = assignees.map(assignee => {\n      return assignee.email;\n    });\n    await addDocumentToSign(uid, email, referenceString, emails);\n    dispatch(resetSignee());\n    navigate('/');\n  };\n\n  const dragOver = e => {\n    e.preventDefault();\n    return false;\n  };\n\n  const drop = (e, instance) => {\n    const {\n      docViewer\n    } = instance;\n    const scrollElement = docViewer.getScrollViewElement();\n    const scrollLeft = scrollElement.scrollLeft || 0;\n    const scrollTop = scrollElement.scrollTop || 0;\n    setDropPoint({\n      x: e.pageX + scrollLeft,\n      y: e.pageY + scrollTop\n    });\n    e.preventDefault();\n    return false;\n  };\n\n  const dragStart = e => {\n    e.target.style.opacity = 0.5;\n    const copy = e.target.cloneNode(true);\n    copy.id = 'form-build-drag-image-copy';\n    copy.style.width = '250px';\n    document.body.appendChild(copy);\n    e.dataTransfer.setDragImage(copy, 125, 25);\n    e.dataTransfer.setData('text', '');\n  };\n\n  const dragEnd = (e, type) => {\n    addField(type, dropPoint);\n    e.target.style.opacity = 1;\n    document.body.removeChild(document.getElementById('form-build-drag-image-copy'));\n    e.preventDefault();\n  };\n\n  return /*#__PURE__*/React.createElement(\"div\", {\n    className: 'prepareDocument',\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 316,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Box, {\n    display: \"flex\",\n    direction: \"row\",\n    flex: \"grow\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 317,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Column, {\n    span: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 318,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Box, {\n    padding: 3,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 319,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Heading, {\n    size: \"md\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 320,\n      columnNumber: 13\n    }\n  }, \"Prepare Document\")), /*#__PURE__*/React.createElement(Box, {\n    padding: 3,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 322,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Row, {\n    gap: 1,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 323,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Stack, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 324,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 325,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(Text, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 326,\n      columnNumber: 19\n    }\n  }, 'Step 1')), /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 328,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    onClick: () => {\n      if (filePicker) {\n        filePicker.current.click();\n      }\n    },\n    accessibilityLabel: \"upload a document\",\n    text: \"Upload a document\",\n    iconEnd: \"add-circle\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 329,\n      columnNumber: 19\n    }\n  })))), /*#__PURE__*/React.createElement(Row, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 342,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Stack, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 343,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 344,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(Text, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 345,\n      columnNumber: 19\n    }\n  }, 'Step 2')), /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 347,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(SelectList, {\n    id: \"assigningFor\",\n    name: \"assign\",\n    onChange: ({\n      value\n    }) => setAssignee(value),\n    options: assigneesValues,\n    placeholder: \"Select recipient\",\n    label: \"Adding signature for\",\n    value: assignee,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 348,\n      columnNumber: 19\n    }\n  })), /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 358,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    draggable: true,\n    onDragStart: e => dragStart(e),\n    onDragEnd: e => dragEnd(e, 'SIGNATURE'),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 359,\n      columnNumber: 19\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    onClick: () => addField('SIGNATURE'),\n    accessibilityLabel: \"add signature\",\n    text: \"Add signature\",\n    iconEnd: \"compose\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 364,\n      columnNumber: 21\n    }\n  }))), /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 372,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    draggable: true,\n    onDragStart: e => dragStart(e),\n    onDragEnd: e => dragEnd(e, 'TEXT'),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 373,\n      columnNumber: 19\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    onClick: () => addField('TEXT'),\n    accessibilityLabel: \"add text\",\n    text: \"Add text\",\n    iconEnd: \"text-sentence-case\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 378,\n      columnNumber: 21\n    }\n  }))), /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 386,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    draggable: true,\n    onDragStart: e => dragStart(e),\n    onDragEnd: e => dragEnd(e, 'DATE'),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 387,\n      columnNumber: 19\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    onClick: () => addField('DATE'),\n    accessibilityLabel: \"add date field\",\n    text: \"Add date\",\n    iconEnd: \"calendar\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 392,\n      columnNumber: 21\n    }\n  }))))), /*#__PURE__*/React.createElement(Row, {\n    gap: 1,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 402,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Stack, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 403,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 404,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(Text, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 405,\n      columnNumber: 19\n    }\n  }, 'Step 3')), /*#__PURE__*/React.createElement(Box, {\n    padding: 2,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 407,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    onClick: applyFields,\n    accessibilityLabel: \"Send for signing\",\n    text: \"Send\",\n    iconEnd: \"send\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 408,\n      columnNumber: 19\n    }\n  })))))), /*#__PURE__*/React.createElement(Column, {\n    span: 10,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 419,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"webviewer\",\n    ref: viewer,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 420,\n      columnNumber: 11\n    }\n  }))), /*#__PURE__*/React.createElement(\"input\", {\n    type: \"file\",\n    ref: filePicker,\n    style: {\n      display: 'none'\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 423,\n      columnNumber: 7\n    }\n  }));\n};\n\n_s(PrepareDocument, \"XAUHijTZfM4dd/LR41i6C8X3yLE=\", false, function () {\n  return [useDispatch, useSelector, useSelector];\n});\n\n_c = PrepareDocument;\nexport default PrepareDocument;\n\nvar _c;\n\n$RefreshReg$(_c, \"PrepareDocument\");","map":{"version":3,"sources":["C:/Users/boy/Desktop/pdf/pdftron-sign-app-master/src/components/PrepareDocument/PrepareDocument.js"],"names":["React","useRef","useEffect","useState","useSelector","useDispatch","navigate","Box","Column","Heading","Row","Stack","Text","Button","SelectList","selectAssignees","resetSignee","storage","addDocumentToSign","selectUser","WebViewer","PrepareDocument","instance","setInstance","dropPoint","setDropPoint","dispatch","assignees","assigneesValues","map","user","value","email","label","name","initialAssignee","length","assignee","setAssignee","uid","viewer","filePicker","path","disabledElements","current","then","iframeWindow","setToolbarGroup","iframeDoc","document","body","addEventListener","dragOver","e","drop","onchange","file","target","files","loadDocument","applyFields","Annotations","docViewer","annotManager","getAnnotationManager","fieldManager","getFieldManager","annotationsList","getAnnotationsList","annotsToDelete","annotsToDraw","Promise","all","annot","index","inputAnnot","field","custom","type","Forms","Field","getContents","Date","now","TextWidgetAnnotation","SignatureWidgetAnnotation","appearance","appearances","_DEFAULT","Normal","data","offset","x","y","actions","F","javascript","K","DatePickerWidgetAnnotation","deleteAnnotation","PageNumber","getPageNumber","X","getX","Y","getY","rotation","Rotation","Width","getWidth","Height","getHeight","push","WidgetAnnotation","getCustomStyles","widget","border","addAnnotation","addField","deleteAnnotations","drawAnnotationsFromList","uploadForSigning","point","flag","doc","getDocument","displayMode","getDisplayModeManager","getDisplayMode","page","getSelectedPages","first","page_idx","getCurrentPage","page_info","getPageInfo","page_point","windowToPage","zoom","getZoom","textAnnot","FreeTextAnnotation","getCompleteRotation","width","height","setPadding","Rect","setContents","FontSize","FillColor","Color","TextColor","StrokeThickness","StrokeColor","TextAlign","Author","getCurrentUser","deselectAllAnnotations","redrawAnnotation","selectAnnotation","storageRef","ref","referenceString","docRef","child","xfdfString","exportAnnotations","widgets","fields","getFileData","arr","Uint8Array","blob","Blob","put","snapshot","console","log","emails","preventDefault","scrollElement","getScrollViewElement","scrollLeft","scrollTop","pageX","pageY","dragStart","style","opacity","copy","cloneNode","id","appendChild","dataTransfer","setDragImage","setData","dragEnd","removeChild","getElementById","click","display"],"mappings":"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","sourcesContent":["import React, { useRef, useEffect, useState } from 'react';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { navigate } from '@reach/router';\nimport {\n  Box,\n  Column,\n  Heading,\n  Row,\n  Stack,\n  Text,\n  Button,\n  SelectList,\n} from 'gestalt';\nimport { selectAssignees, resetSignee } from '../Assign/AssignSlice';\nimport { storage, addDocumentToSign } from '../../firebase/firebase';\nimport { selectUser } from '../../firebase/firebaseSlice';\nimport WebViewer from '@pdftron/webviewer';\nimport 'gestalt/dist/gestalt.css';\nimport './PrepareDocument.css';\n\nconst PrepareDocument = () => {\n  const [instance, setInstance] = useState(null);\n  const [dropPoint, setDropPoint] = useState(null);\n\n  const dispatch = useDispatch();\n\n  const assignees = useSelector(selectAssignees);\n  const assigneesValues = assignees.map(user => {\n    return { value: user.email, label: user.name };\n  });\n  let initialAssignee =\n    assigneesValues.length > 0 ? assigneesValues[0].value : '';\n  const [assignee, setAssignee] = useState(initialAssignee);\n\n  const user = useSelector(selectUser);\n  const { uid, email } = user;\n\n  const viewer = useRef(null);\n  const filePicker = useRef(null);\n\n  // if using a class, equivalent of componentDidMount\n  useEffect(() => {\n    WebViewer(\n      {\n        path: 'webviewer',\n        disabledElements: [\n          'ribbons',\n          'toggleNotesButton',\n          'searchButton',\n          'menuButton',\n        ],\n      },\n      viewer.current,\n    ).then(instance => {\n      const { iframeWindow } = instance;\n\n      // select only the view group\n      instance.setToolbarGroup('toolbarGroup-View');\n\n      setInstance(instance);\n\n      const iframeDoc = iframeWindow.document.body;\n      iframeDoc.addEventListener('dragover', dragOver);\n      iframeDoc.addEventListener('drop', e => {\n        drop(e, instance);\n      });\n\n      filePicker.current.onchange = e => {\n        const file = e.target.files[0];\n        if (file) {\n          instance.loadDocument(file);\n        }\n      };\n    });\n  }, []);\n\n  const applyFields = async () => {\n    const { Annotations, docViewer } = instance;\n    const annotManager = docViewer.getAnnotationManager();\n    const fieldManager = annotManager.getFieldManager();\n    const annotationsList = annotManager.getAnnotationsList();\n    const annotsToDelete = [];\n    const annotsToDraw = [];\n\n    await Promise.all(\n      annotationsList.map(async (annot, index) => {\n        let inputAnnot;\n        let field;\n\n        if (typeof annot.custom !== 'undefined') {\n          // create a form field based on the type of annotation\n          if (annot.custom.type === 'TEXT') {\n            field = new Annotations.Forms.Field(\n              annot.getContents() + Date.now() + index,\n              {\n                type: 'Tx',\n                value: annot.custom.value,\n              },\n            );\n            inputAnnot = new Annotations.TextWidgetAnnotation(field);\n          } else if (annot.custom.type === 'SIGNATURE') {\n            field = new Annotations.Forms.Field(\n              annot.getContents() + Date.now() + index,\n              {\n                type: 'Sig',\n              },\n            );\n            inputAnnot = new Annotations.SignatureWidgetAnnotation(field, {\n              appearance: '_DEFAULT',\n              appearances: {\n                _DEFAULT: {\n                  Normal: {\n                    data:\n                      'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuMWMqnEsAAAANSURBVBhXY/j//z8DAAj8Av6IXwbgAAAAAElFTkSuQmCC',\n                    offset: {\n                      x: 100,\n                      y: 100,\n                    },\n                  },\n                },\n              },\n            });\n          } else if (annot.custom.type === 'DATE') {\n            field = new Annotations.Forms.Field(\n              annot.getContents() + Date.now() + index,\n              {\n                type: 'Tx',\n                value: 'm-d-yyyy',\n                // Actions need to be added for DatePickerWidgetAnnotation to recognize this field.\n                actions: {\n                  F: [\n                    {\n                      name: 'JavaScript',\n                      // You can customize the date format here between the two double-quotation marks\n                      // or leave this blank to use the default format\n                      javascript: 'AFDate_FormatEx(\"mmm d, yyyy\");',\n                    },\n                  ],\n                  K: [\n                    {\n                      name: 'JavaScript',\n                      // You can customize the date format here between the two double-quotation marks\n                      // or leave this blank to use the default format\n                      javascript: 'AFDate_FormatEx(\"mmm d, yyyy\");',\n                    },\n                  ],\n                },\n              },\n            );\n  \n            inputAnnot = new Annotations.DatePickerWidgetAnnotation(field);\n          } else {\n            // exit early for other annotations\n            annotManager.deleteAnnotation(annot, false, true); // prevent duplicates when importing xfdf\n            return;\n          }\n        } else {\n          // exit early for other annotations\n          return;\n        }\n\n        // set position\n        inputAnnot.PageNumber = annot.getPageNumber();\n        inputAnnot.X = annot.getX();\n        inputAnnot.Y = annot.getY();\n        inputAnnot.rotation = annot.Rotation;\n        if (annot.Rotation === 0 || annot.Rotation === 180) {\n          inputAnnot.Width = annot.getWidth();\n          inputAnnot.Height = annot.getHeight();\n        } else {\n          inputAnnot.Width = annot.getHeight();\n          inputAnnot.Height = annot.getWidth();\n        }\n\n        // delete original annotation\n        annotsToDelete.push(annot);\n\n        // customize styles of the form field\n        Annotations.WidgetAnnotation.getCustomStyles = function (widget) {\n          if (widget instanceof Annotations.SignatureWidgetAnnotation) {\n            return {\n              border: '1px solid #a5c7ff',\n            };\n          }\n        };\n        Annotations.WidgetAnnotation.getCustomStyles(inputAnnot);\n\n        // draw the annotation the viewer\n        annotManager.addAnnotation(inputAnnot);\n        fieldManager.addField(field);\n        annotsToDraw.push(inputAnnot);\n      }),\n    );\n\n    // delete old annotations\n    annotManager.deleteAnnotations(annotsToDelete, null, true);\n\n    // refresh viewer\n    await annotManager.drawAnnotationsFromList(annotsToDraw);\n    await uploadForSigning();\n  };\n\n  const addField = (type, point = {}, name = '', value = '', flag = {}) => {\n    const { docViewer, Annotations } = instance;\n    const annotManager = docViewer.getAnnotationManager();\n    const doc = docViewer.getDocument();\n    const displayMode = docViewer.getDisplayModeManager().getDisplayMode();\n    const page = displayMode.getSelectedPages(point, point);\n    if (!!point.x && page.first == null) {\n      return; //don't add field to an invalid page location\n    }\n    const page_idx =\n      page.first !== null ? page.first : docViewer.getCurrentPage();\n    const page_info = doc.getPageInfo(page_idx);\n    const page_point = displayMode.windowToPage(point, page_idx);\n    const zoom = docViewer.getZoom();\n\n    var textAnnot = new Annotations.FreeTextAnnotation();\n    textAnnot.PageNumber = page_idx;\n    const rotation = docViewer.getCompleteRotation(page_idx) * 90;\n    textAnnot.Rotation = rotation;\n    if (rotation === 270 || rotation === 90) {\n      textAnnot.Width = 50.0 / zoom;\n      textAnnot.Height = 250.0 / zoom;\n    } else {\n      textAnnot.Width = 250.0 / zoom;\n      textAnnot.Height = 50.0 / zoom;\n    }\n    textAnnot.X = (page_point.x || page_info.width / 2) - textAnnot.Width / 2;\n    textAnnot.Y = (page_point.y || page_info.height / 2) - textAnnot.Height / 2;\n\n    textAnnot.setPadding(new Annotations.Rect(0, 0, 0, 0));\n    textAnnot.custom = {\n      type,\n      value,\n      flag,\n      name: `${assignee}_${type}_`,\n    };\n\n    // set the type of annot\n    textAnnot.setContents(textAnnot.custom.name);\n    textAnnot.FontSize = '' + 20.0 / zoom + 'px';\n    textAnnot.FillColor = new Annotations.Color(211, 211, 211, 0.5);\n    textAnnot.TextColor = new Annotations.Color(0, 165, 228);\n    textAnnot.StrokeThickness = 1;\n    textAnnot.StrokeColor = new Annotations.Color(0, 165, 228);\n    textAnnot.TextAlign = 'center';\n\n    textAnnot.Author = annotManager.getCurrentUser();\n\n    annotManager.deselectAllAnnotations();\n    annotManager.addAnnotation(textAnnot, true);\n    annotManager.redrawAnnotation(textAnnot);\n    annotManager.selectAnnotation(textAnnot);\n  };\n\n  const uploadForSigning = async () => {\n    // upload the PDF with fields as AcroForm\n    const storageRef = storage.ref();\n    const referenceString = `docToSign/${uid}${Date.now()}.pdf`;\n    const docRef = storageRef.child(referenceString);\n    const { docViewer, annotManager } = instance;\n    const doc = docViewer.getDocument();\n    const xfdfString = await annotManager.exportAnnotations({ widgets: true, fields: true });\n    const data = await doc.getFileData({ xfdfString });\n    const arr = new Uint8Array(data);\n    const blob = new Blob([arr], { type: 'application/pdf' });\n    docRef.put(blob).then(function (snapshot) {\n      console.log('Uploaded the blob');\n    });\n\n    // create an entry in the database\n    const emails = assignees.map(assignee => {\n      return assignee.email;\n    });\n    await addDocumentToSign(uid, email, referenceString, emails);\n    dispatch(resetSignee());\n    navigate('/');\n  };\n\n  const dragOver = e => {\n    e.preventDefault();\n    return false;\n  };\n\n  const drop = (e, instance) => {\n    const { docViewer } = instance;\n    const scrollElement = docViewer.getScrollViewElement();\n    const scrollLeft = scrollElement.scrollLeft || 0;\n    const scrollTop = scrollElement.scrollTop || 0;\n    setDropPoint({ x: e.pageX + scrollLeft, y: e.pageY + scrollTop });\n    e.preventDefault();\n    return false;\n  };\n\n  const dragStart = e => {\n    e.target.style.opacity = 0.5;\n    const copy = e.target.cloneNode(true);\n    copy.id = 'form-build-drag-image-copy';\n    copy.style.width = '250px';\n    document.body.appendChild(copy);\n    e.dataTransfer.setDragImage(copy, 125, 25);\n    e.dataTransfer.setData('text', '');\n  };\n\n  const dragEnd = (e, type) => {\n    addField(type, dropPoint);\n    e.target.style.opacity = 1;\n    document.body.removeChild(\n      document.getElementById('form-build-drag-image-copy'),\n    );\n    e.preventDefault();\n  };\n\n  return (\n    <div className={'prepareDocument'}>\n      <Box display=\"flex\" direction=\"row\" flex=\"grow\">\n        <Column span={2}>\n          <Box padding={3}>\n            <Heading size=\"md\">Prepare Document</Heading>\n          </Box>\n          <Box padding={3}>\n            <Row gap={1}>\n              <Stack>\n                <Box padding={2}>\n                  <Text>{'Step 1'}</Text>\n                </Box>\n                <Box padding={2}>\n                  <Button\n                    onClick={() => {\n                      if (filePicker) {\n                        filePicker.current.click();\n                      }\n                    }}\n                    accessibilityLabel=\"upload a document\"\n                    text=\"Upload a document\"\n                    iconEnd=\"add-circle\"\n                  />\n                </Box>\n              </Stack>\n            </Row>\n            <Row>\n              <Stack>\n                <Box padding={2}>\n                  <Text>{'Step 2'}</Text>\n                </Box>\n                <Box padding={2}>\n                  <SelectList\n                    id=\"assigningFor\"\n                    name=\"assign\"\n                    onChange={({ value }) => setAssignee(value)}\n                    options={assigneesValues}\n                    placeholder=\"Select recipient\"\n                    label=\"Adding signature for\"\n                    value={assignee}\n                  />\n                </Box>\n                <Box padding={2}>\n                  <div\n                    draggable\n                    onDragStart={e => dragStart(e)}\n                    onDragEnd={e => dragEnd(e, 'SIGNATURE')}\n                  >\n                    <Button\n                      onClick={() => addField('SIGNATURE')}\n                      accessibilityLabel=\"add signature\"\n                      text=\"Add signature\"\n                      iconEnd=\"compose\"\n                    />\n                  </div>\n                </Box>\n                <Box padding={2}>\n                  <div\n                    draggable\n                    onDragStart={e => dragStart(e)}\n                    onDragEnd={e => dragEnd(e, 'TEXT')}\n                  >\n                    <Button\n                      onClick={() => addField('TEXT')}\n                      accessibilityLabel=\"add text\"\n                      text=\"Add text\"\n                      iconEnd=\"text-sentence-case\"\n                    />\n                  </div>\n                </Box>\n                <Box padding={2}>\n                  <div\n                    draggable\n                    onDragStart={e => dragStart(e)}\n                    onDragEnd={e => dragEnd(e, 'DATE')}\n                  >\n                    <Button\n                      onClick={() => addField('DATE')}\n                      accessibilityLabel=\"add date field\"\n                      text=\"Add date\"\n                      iconEnd=\"calendar\"\n                    />\n                  </div>\n                </Box>\n              </Stack>\n            </Row>\n            <Row gap={1}>\n              <Stack>\n                <Box padding={2}>\n                  <Text>{'Step 3'}</Text>\n                </Box>\n                <Box padding={2}>\n                  <Button\n                    onClick={applyFields}\n                    accessibilityLabel=\"Send for signing\"\n                    text=\"Send\"\n                    iconEnd=\"send\"\n                  />\n                </Box>\n              </Stack>\n            </Row>\n          </Box>\n        </Column>\n        <Column span={10}>\n          <div className=\"webviewer\" ref={viewer}></div>\n        </Column>\n      </Box>\n      <input type=\"file\" ref={filePicker} style={{ display: 'none' }} />\n    </div>\n  );\n};\n\nexport default PrepareDocument;\n"]},"metadata":{},"sourceType":"module"}